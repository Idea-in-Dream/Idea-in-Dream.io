<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Proposal</title>

  <!-- Fonts (可自行替换) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Cormorant+Garamond:wght@400;500;600&family=Great+Vibes&family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- GSAP (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.3/gsap.min.js"></script>

  <!-- canvas-confetti (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      /* ===== 亮底：日落粉 / 蜜桃 / 香槟金 ===== */
      --bg1:#FFF3F1;          /* very light blush */
      --bg2:#FFE2EC;          /* peach-pink */
      --bg3:#FFD2B5;          /* warm apricot */
      --text:#2A1C23;         /* deep warm ink */
      --muted:rgba(42,28,35,.72);
      --glass:rgba(255,255,255,.56);
      --glass2:rgba(255,255,255,.68);
      --stroke:rgba(194,120,150,.22);
      --gold:#D0A45E;         /* champagne */
      --blush:#FF7FA8;        /* accent pink */
      --shadow: 0 18px 60px rgba(44,20,30,.22);
      --radius: 22px;
      --maxw: 1080px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1100px 800px at 15% 10%, rgba(255,127,168,.28), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(255,210,181,.55), transparent 52%),
        radial-gradient(1200px 900px at 55% 95%, rgba(208,164,94,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 35%, var(--bg3));
      overflow-x:hidden;
      font-family:"Noto Serif SC","Cormorant Garamond",serif;
      letter-spacing:.2px;
    }

    /* 轻闪光粒子画布（亮底替代星空） */
    #sparkles{
      position:fixed; inset:0;
      z-index:-3;
      opacity:.65;
      pointer-events:none;
    }

    /* 花瓣粒子（CSS + DOM） */
    #petals{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-2;
      overflow:hidden;
      opacity:.55;
    }
    .petal{
      position:absolute;
      width:16px; height:10px;
      border-radius: 999px 999px 999px 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,127,168,.45) 38%, rgba(255,127,168,.10) 72%, transparent 80%);
      filter: blur(.1px);
      transform: rotate(20deg);
      animation: fall linear infinite;
    }
    @keyframes fall{
      from{ transform: translate3d(0,-10vh,0) rotate(0deg); opacity:0; }
      10%{opacity:.9}
      to{ transform: translate3d(var(--dx),110vh,0) rotate(var(--rot)); opacity:0; }
    }

    /* 入场帷幕（亮底版） */
    #curtain{
      position:fixed; inset:0;
      z-index:9999;
      background:
        radial-gradient(1200px 900px at 40% 25%, rgba(255,255,255,.92), rgba(255,255,255,.35) 55%, transparent 70%),
        radial-gradient(900px 700px at 70% 45%, rgba(255,127,168,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,243,241,.92), rgba(255,226,236,.92));
      display:flex; align-items:center; justify-content:center;
    }
    #curtain .logo{
      font-family:"Cinzel",serif;
      letter-spacing:.35em;
      text-transform:uppercase;
      color: rgba(42,28,35,.78);
      transform: translateY(6px);
    }

    /* 顶部章节标签 */
    #chapterBar{
      position:fixed; left:0; right:0; top:0;
      z-index:50;
      padding: 18px 18px 0 18px;
      pointer-events:none;
    }
    #chapterBar .inner{
      max-width: var(--maxw);
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .chapterTag{
      font-family:"Cinzel",serif;
      font-size:12px;
      letter-spacing:.38em;
      color: rgba(208,164,94,.95);
      text-transform:uppercase;
      text-shadow: 0 10px 30px rgba(255,255,255,.55);
      pointer-events:none;
    }
    .musicBtn{
      pointer-events:auto;
      display:none;
      align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.48);
      border:1px solid rgba(208,164,94,.28);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(42,28,35,.85);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 30px rgba(44,20,30,.10);
    }
    .musicBtn:hover{ background: rgba(255,255,255,.62); }

    /* 章节布局 */
    main{ position:relative; z-index:1; }
    section.chapter{
      min-height: 100vh;
      display:flex;
      align-items:center;
      padding: 88px 18px 70px 18px;
    }
    .wrap{
      max-width: var(--maxw);
      width:100%;
      margin:0 auto;
      position:relative;
    }

    /* 玻璃卡片（亮底玻璃） */
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.50));
      border: 1px solid rgba(194,120,150,.18);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      position:relative;
    }
    .glowEdge::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(620px 240px at 18% 12%, rgba(255,127,168,.22), transparent 58%),
        radial-gradient(520px 260px at 84% 30%, rgba(208,164,94,.18), transparent 62%),
        radial-gradient(520px 300px at 52% 98%, rgba(255,210,181,.28), transparent 64%);
      filter: blur(18px);
      opacity:.65;
      z-index:0;
      pointer-events:none;
    }
    .content{
      position:relative;
      z-index:1;
      padding: 34px 30px 26px 30px;
    }

    /* 标题体系 */
    .kicker{
      font-family:"Cinzel",serif;
      letter-spacing:.35em;
      color: rgba(208,164,94,.95);
      font-size: 12px;
      text-transform:uppercase;
      margin:0 0 16px 0;
    }
    h1{
      margin:0 0 10px 0;
      font-size: 44px;
      line-height:1.1;
      font-weight:600;
      font-family:"Cormorant Garamond","Noto Serif SC",serif;
      color: rgba(42,28,35,.92);
    }
    .subtitle{
      margin:0 0 18px 0;
      color: var(--muted);
      font-size: 16px;
      line-height:1.7;
    }

    /* 章节底部旁白条（章节旁白，不是“每月旁白”） */
    .narrationBar{
      position:absolute;
      left:0; right:0; bottom:-18px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .narrationBar .pill{
      max-width: min(var(--maxw), calc(100vw - 36px));
      background: rgba(255,255,255,.52);
      border: 1px solid rgba(208,164,94,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(44,20,30,.10);
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      line-height:1.65;
      color: rgba(42,28,35,.86);
      letter-spacing:.2px;
      text-align:center;
    }
    .narrationText{
      display:inline-block;
      min-height: 1.6em;
      white-space:nowrap;
      overflow:hidden;
      border-right: 1px solid rgba(208,164,94,.55);
      padding-right: 6px;
    }

    /* Intro cover */
    .cover{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 22px;
      align-items:stretch;
    }
    .coverImg{
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(208,164,94,.18);
      background: rgba(255,255,255,.35);
      position:relative;
      min-height: 360px;
    }
    .coverImg img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter: saturate(1.08) contrast(1.03);
      opacity:.96;
    }
    .coverImg::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 420px at 20% 10%, rgba(255,127,168,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(44,20,30,.20));
      pointer-events:none;
    }
    .hint{
      margin-top:14px;
      color: rgba(42,28,35,.62);
      font-size: 13px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-family:"Cinzel",serif;
    }

    /* Love Animation page */
    .loveStage{
      position:relative;
      height: 68vh;
      min-height: 520px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(208,164,94,.20);
      background:
        radial-gradient(800px 520px at 20% 20%, rgba(255,127,168,.24), transparent 60%),
        radial-gradient(900px 600px at 80% 70%, rgba(255,210,181,.55), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.24));
    }
    #loveCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
    }
    .loveOverlayText{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      text-align:center;
      padding: 0 18px;
      z-index:2;
    }
    .loveOverlayText .big{
      font-family:"Great Vibes","Cormorant Garamond",serif;
      font-size: 68px;
      margin:0 0 6px 0;
      color: rgba(42,28,35,.90);
      text-shadow: 0 18px 60px rgba(255,255,255,.60);
    }
    .loveOverlayText .small{
      font-family:"Cinzel",serif;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size: 12px;
      color: rgba(208,164,94,.95);
      margin:0;
    }

    /* Timeline */
    .timelineStage{
      position:relative;
      height: 70vh;
      min-height: 520px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(208,164,94,.20);
      background:
        radial-gradient(800px 520px at 20% 20%, rgba(255,127,168,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 70%, rgba(255,210,181,.55), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.38), rgba(255,255,255,.22));
    }
    .monthSlide{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
      padding: 18px;
      opacity:0;
      transform: scale(1.02);
      z-index:1;
    }
    .monthPhoto{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(208,164,94,.16);
      background: rgba(255,255,255,.24);
      position:relative;
    }
    .monthPhoto img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter: contrast(1.04) saturate(1.08);
      opacity:.98;
    }
    .monthCard{
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.48));
      border:1px solid rgba(208,164,94,.18);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(44,20,30,.12);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 10px;
    }
    .monthTitle{
      font-size: 22px;
      line-height:1.3;
      margin:0;
      font-family:"Cormorant Garamond","Noto Serif SC",serif;
      font-weight:600;
      color: rgba(42,28,35,.92);
    }
    .monthCaption{
      margin:0;
      color: rgba(42,28,35,.76);
      font-size: 15px;
      line-height:1.85;
    }

    /* ===== 每月旁白：浮在画面正中 ===== */
    .monthNarrationCenter{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index:5;
      pointer-events:none;
      width: min(860px, calc(100% - 44px));
      text-align:center;
    }
    .monthNarrationCenter .pill{
      display:inline-block;
      padding: 12px 18px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border:1px solid rgba(208,164,94,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 46px rgba(44,20,30,.12);
      color: rgba(42,28,35,.86);
      font-size: 15px;
      line-height: 1.9;
    }
    .monthNarrationCenter .type{
      display:inline-block;
      min-height: 1.9em;
      white-space:nowrap;
      overflow:hidden;
      border-right: 1px solid rgba(208,164,94,.55);
      padding-right: 8px;
    }

    .progressRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 12px;
      color: rgba(42,28,35,.68);
      font-size: 12px;
      letter-spacing:.16em;
      font-family:"Cinzel",serif;
      text-transform:uppercase;
    }
    .bar{
      flex:1;
      height: 2px;
      background: rgba(208,164,94,.22);
      border-radius: 999px;
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: rgba(208,164,94,.90);
    }

    /* Bullets */
    ul.bullets{
      margin: 12px 0 0 0;
      padding: 0 0 0 18px;
      color: rgba(42,28,35,.88);
      line-height: 2.0;
      font-size: 16px;
    }

    /* Guess */
    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    .opt{
      padding: 14px 14px;
      border-radius: 16px;
      border:1px solid rgba(208,164,94,.22);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .15s ease;
      color: rgba(42,28,35,.88);
      line-height:1.6;
      box-shadow: 0 12px 34px rgba(44,20,30,.10);
    }
    .opt:hover{ transform: translateY(-2px); background: rgba(255,255,255,.68); }
    .opt.selected{ border-color: rgba(208,164,94,.55); background: rgba(208,164,94,.14); }
    .reveal{
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,127,168,.30);
      background: rgba(255,127,168,.12);
      display:none;
      line-height:1.85;
      color: rgba(42,28,35,.90);
    }

    /* Buttons */
    .ctaRow{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 18px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(208,164,94,.35);
      background: linear-gradient(180deg, rgba(208,164,94,.28), rgba(208,164,94,.14));
      color: rgba(42,28,35,.92);
      padding: 12px 18px;
      border-radius: 999px;
      font-family:"Cinzel",serif;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      box-shadow: 0 16px 40px rgba(44,20,30,.14);
      transition: transform .15s ease, background .15s ease;
    }
    .btn:hover{ transform: translateY(-2px); background: linear-gradient(180deg, rgba(208,164,94,.34), rgba(208,164,94,.18)); }

    /* 求婚按钮：大“我愿意”+小“我不愿意” —— 已加大 */
    .btnBigYes{
      padding: 22px 52px;            /* 更大 */
      font-size: 14px;               /* 更大 */
      letter-spacing:.22em;
      font-weight:700;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      min-width: 260px;
      box-shadow: 0 22px 60px rgba(44,20,30,.18);
      background: linear-gradient(180deg, rgba(255,127,168,.26), rgba(208,164,94,.18));
      border-color: rgba(255,127,168,.35);
    }
    .btnBigYes:hover{
      transform: translateY(-3px);
      background: linear-gradient(180deg, rgba(255,127,168,.32), rgba(208,164,94,.22));
      filter: saturate(1.06);
    }
    .btnBigYes .sub{
      font-family:"Cinzel",serif;
      font-size: 11px;
      letter-spacing:.26em;
      opacity:.9;
    }

    .btnTinyNo{
      padding: 9px 12px;
      font-size: 11px;
      letter-spacing:.10em;
      opacity:.90;
      background: rgba(255,255,255,.52);
      border: 1px solid rgba(42,28,35,.14);
      box-shadow: 0 14px 36px rgba(44,20,30,.10);
    }
    .btnTinyNo:hover{ opacity:1; transform: translateY(-1px); }

    .afterText{
      color: rgba(42,28,35,.78);
      line-height:1.9;
      font-size: 15px;
      display:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.48);
      border:1px solid rgba(208,164,94,.18);
    }

    /* Chapter nav: 回看 / 继续 */
    .chapterNav{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 16px;
      flex-wrap:wrap;
    }
    .mBtn{
      border:1px solid rgba(42,28,35,.14);
      background: rgba(255,255,255,.52);
      color: rgba(42,28,35,.85);
      padding: 10px 14px;
      border-radius: 999px;
      font-family:"Cinzel",serif;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
      box-shadow: 0 14px 36px rgba(44,20,30,.10);
      transition: transform .15s ease, background .15s ease;
    }
    .mBtn:hover{ transform: translateY(-2px); background: rgba(255,255,255,.66); }
    .mBtn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .mLabel{
      font-family:"Cinzel",serif;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(42,28,35,.62);
      font-size: 12px;
      align-self:center;
      text-align:center;
    }

    /* 第零页：倒计时 */
    .countNum{
      font-family:"Cinzel",serif;
      font-size: 120px;
      letter-spacing:.10em;
      margin:0;
      color: rgba(42,28,35,.82);
      text-shadow: 0 24px 70px rgba(255,255,255,.70);
    }
    .countHint{
      margin: 10px 0 18px 0;
      font-family:"Cinzel",serif;
      letter-spacing:.26em;
      text-transform:uppercase;
      color: rgba(208,164,94,.95);
      font-size: 12px;
    }

    /* Finale overlay: fireworks */
    #finaleOverlay{
      position:fixed; inset:0;
      z-index:9998;
      display:none;
      background:
        radial-gradient(1000px 700px at 50% 30%, rgba(255,127,168,.26), transparent 55%),
        radial-gradient(900px 700px at 60% 80%, rgba(255,210,181,.65), transparent 60%),
        linear-gradient(180deg, rgba(255,243,241,.55), rgba(42,28,35,.72));
    }
    #finaleCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
    }
    .finaleText{
      position:absolute;
      left:50%; top:16%;
      transform:translateX(-50%);
      text-align:center;
      padding: 0 18px;
      max-width: 960px;
    }
    .finaleText .big{
      font-family:"Great Vibes","Cormorant Garamond",serif;
      font-size: 66px;
      margin:0 0 8px 0;
      color: rgba(255,255,255,.98);
      text-shadow: 0 18px 60px rgba(0,0,0,.25);
    }
    .finaleText .small{
      font-family:"Cinzel",serif;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      margin:0;
    }

    /* Smoke layer */
    .smoke{
      position:absolute; inset:-20%;
      background:
        radial-gradient(600px 420px at 30% 50%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(700px 500px at 70% 45%, rgba(255,255,255,.12), transparent 62%),
        radial-gradient(900px 620px at 50% 60%, rgba(255,255,255,.10), transparent 65%);
      filter: blur(26px);
      opacity: .0;
      animation: smokeMove 10s ease-in-out infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes smokeMove{
      0%{ transform: translate3d(-2%, -1%,0) scale(1.02); }
      50%{ transform: translate3d(2%, 1%,0) scale(1.06); }
      100%{ transform: translate3d(-2%, -1%,0) scale(1.02); }
    }

    /* ===== 终章两页：End Card（烟花后弹出） ===== */
    #endCard{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
    }
    #endCard[aria-hidden="false"]{ display:block; }

    .endCardMask{
      position:absolute;
      inset:0;
      background: rgba(42,28,35,.26);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .endCardBox{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: min(820px, calc(100% - 44px));
      border-radius: 24px;
    }
    .endCardContent{
      padding: 30px 24px 24px 24px;
      text-align:center;
      position:relative;
      z-index:1;
    }

    /* 响应式 */
    @media (max-width: 980px){
      .cover{ grid-template-columns: 1fr; }
      .monthSlide{ grid-template-columns: 1fr; }
      h1{ font-size: 38px; }
      .timelineStage{ height: 66vh; }
      .loveStage{ height: 64vh; }
      .options{ grid-template-columns: 1fr; }
      .finaleText .big{ font-size: 54px; }
      .loveOverlayText .big{ font-size: 56px; }
      .countNum{ font-size: 92px; }
      .monthNarrationCenter .pill{ font-size: 14px; }
      .btnBigYes{ min-width: 240px; padding: 20px 44px; }
    }

    @media (prefers-reduced-motion: reduce){
      .petal{ animation: none !important; }
      #curtain{ display:none !important; }
    }
  </style>
</head>

<body>
  <canvas id="sparkles"></canvas>
  <div id="petals"></div>

  <div id="curtain">
    <div class="logo">A LOVE STORY</div>
  </div>

  <div id="chapterBar">
    <div class="inner">
      <div class="chapterTag" id="chapterTag">CHAPTER</div>
      <div class="musicBtn" id="musicBtn" role="button" aria-label="Toggle music">BGM</div>
    </div>
  </div>

  <main id="app"></main>

  <div id="finaleOverlay" aria-hidden="true">
    <canvas id="finaleCanvas"></canvas>
    <div class="smoke" id="smokeLayer"></div>
    <div class="finaleText">
      <p class="big" id="finaleTitle">For You</p>
      <p class="small" id="finaleSub">Press Esc to exit</p>
    </div>
  </div>

  <!-- 终章提示卡（烟花后出现）：两段文案（两页效果） -->
  <div id="endCard" aria-hidden="true">
    <div class="endCardMask"></div>
    <div class="endCardBox glass glowEdge">
      <div class="endCardContent">
        <div class="kicker" id="endCardKicker">EPILOGUE</div>
        <h1 style="margin:0 0 10px 0;" id="endCardTitle">你以为这就完了</h1>
        <p class="subtitle" id="endCardBody" style="margin:0;">
          确实这就结束了，但我们的故事将继续。<br/>
          请点击确定。
        </p>

        <div class="ctaRow" style="justify-content:center;margin-top:18px;">
          <button class="btn" id="endCardOkBtn" type="button">确定</button>
          <button class="mBtn" id="endCardCloseBtn" type="button" style="display:none;">知道了</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =============================
   小工具
============================= */
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function setRootTheme(theme){
  if(!theme) return;
  const r = document.documentElement;
  if(theme.text)  r.style.setProperty('--text', theme.text);
  if(theme.accent) r.style.setProperty('--gold', theme.accent);
  if(theme.blush)  r.style.setProperty('--blush', theme.blush);
  // 亮底配色可通过 content.json 扩展覆盖
  if(theme.bg1) r.style.setProperty('--bg1', theme.bg1);
  if(theme.bg2) r.style.setProperty('--bg2', theme.bg2);
  if(theme.bg3) r.style.setProperty('--bg3', theme.bg3);
}

async function loadContent(){
  const res = await fetch('content.json', {cache:'no-store'});
  if(!res.ok) throw new Error('Failed to load content.json');
  return await res.json();
}

/* =============================
   背景：sparkles（亮底微闪）
============================= */
function initSparkles(){
  const c = $('#sparkles');
  const ctx = c.getContext('2d');
  let w=0,h=0, pts=[];
  function resize(){
    w = c.width = window.innerWidth * devicePixelRatio;
    h = c.height = window.innerHeight * devicePixelRatio;
    c.style.width = window.innerWidth+'px';
    c.style.height = window.innerHeight+'px';
    const n = Math.floor((window.innerWidth*window.innerHeight)/18000);
    pts = Array.from({length:n}, ()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      r: (Math.random()*1.8 + .6) * devicePixelRatio,
      a: Math.random()*0.25 + 0.10,
      t: Math.random()*Math.PI*2,
      s: Math.random()*0.008 + 0.004
    }));
  }
  function tick(){
    ctx.clearRect(0,0,w,h);
    for(const p of pts){
      p.t += p.s;
      const tw = (Math.sin(p.t) * 0.15 + 0.85);
      ctx.globalAlpha = p.a * tw;
      // 白金色亮点
      ctx.fillStyle = 'rgba(255,255,255,1)';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r*0.55, 0, Math.PI*2);
      ctx.fill();
      // 小光晕
      ctx.globalAlpha = (p.a*0.6) * tw;
      ctx.fillStyle = 'rgba(208,164,94,1)';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r*1.15, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(tick);
  }
  window.addEventListener('resize', resize);
  resize(); tick();
}

/* =============================
   花瓣粒子（CSS + DOM）
============================= */
function initPetals(){
  const box = $('#petals');
  const MAX = 16;
  function spawn(){
    const d = document.createElement('div');
    d.className = 'petal';
    const x = Math.random()*100;
    const dx = (Math.random()*40-20)+'vw';
    const rot = (Math.random()*720-360)+'deg';
    const dur = (Math.random()*7+8); // 8~15s
    const delay = (Math.random()*2);
    const scale = (Math.random()*0.9+0.6);
    d.style.left = x+'vw';
    d.style.top = (-10 - Math.random()*20)+'vh';
    d.style.setProperty('--dx', dx);
    d.style.setProperty('--rot', rot);
    d.style.animationDuration = dur+'s';
    d.style.animationDelay = delay+'s';
    d.style.transform = `scale(${scale}) rotate(${Math.random()*40}deg)`;
    box.appendChild(d);
    setTimeout(()=>d.remove(), (dur+delay)*1000);
  }
  for(let i=0;i<MAX;i++) spawn();
  setInterval(()=>{ if(box.childElementCount < MAX) spawn(); }, 520);
}

/* =============================
   字幕打字机（可复用）
============================= */
function typeText(targetEl, text, speed=28){
  if(!targetEl) return ()=>{};
  targetEl.textContent = '';
  let i=0;
  const timer = setInterval(()=>{
    targetEl.textContent = text.slice(0, i++);
    if(i > text.length) clearInterval(timer);
  }, speed);
  return ()=>clearInterval(timer);
}

/* =============================
   安全转义
============================= */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, (m)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

/* =============================
   章节模板
============================= */
function sectionTemplate({chapter, title, subtitle}, innerHTML){
  return `
    <div class="wrap">
      <div class="glass glowEdge">
        <div class="content">
          <div class="kicker">${chapter || ''}</div>
          <h1>${escapeHtml(title || '')}</h1>
          <p class="subtitle">${escapeHtml(subtitle || '')}</p>
          ${innerHTML || ''}
          <div class="chapterNav" data-chapnav>
            <button class="mBtn" data-prev type="button">回看</button>
            <button class="btn" data-next type="button">继续</button>
          </div>
        </div>
      </div>
      <div class="narrationBar">
        <div class="pill"><span class="narrationText" data-narration></span></div>
      </div>
    </div>
  `;
}

/* =============================
   渲染 App
============================= */
function buildApp(data){
  const app = $('#app');
  app.innerHTML = '';

  // 第零页：倒计时
  const zero = document.createElement('section');
  zero.className = 'chapter';
  zero.dataset.chapter = data.zero?.chapter || 'PROLOGUE';
  zero.dataset.narration = data.zero?.narration || '当倒计时结束，你将进入我们的故事。';
  zero.innerHTML = `
    <div class="wrap">
      <div class="glass glowEdge">
        <div class="content" style="text-align:center;">
          <div class="kicker">${escapeHtml(data.zero?.chapter || 'PROLOGUE')}</div>
          <p class="countNum" id="countNum">5</p>
          <p class="countHint">${escapeHtml(data.zero?.hint || 'Ready')}</p>
          <p class="subtitle" style="margin-top:6px;">${escapeHtml(data.zero?.subtitle || '请把屏幕交给浪漫。')}</p>

          <div class="ctaRow" style="justify-content:center;margin-top:14px;">
            <button class="btn" id="readyBtn" type="button" style="display:none;">
              ${escapeHtml(data.zero?.buttonText || '我准备好了')}
            </button>
          </div>
        </div>
      </div>
      <div class="narrationBar">
        <div class="pill"><span class="narrationText" data-narration></span></div>
      </div>
    </div>
  `;
  app.appendChild(zero);

  // 爱情动画页
  const love = document.createElement('section');
  love.className = 'chapter';
  love.dataset.chapter = data.love?.chapter || 'CHAPTER I';
  love.dataset.narration = data.love?.narration || '有些心动，不需要理由。';
  love.innerHTML = sectionTemplate(data.love || {}, `
    <div class="loveStage">
      <canvas id="loveCanvas"></canvas>
      <div class="loveOverlayText">
        <p class="big">${escapeHtml(data.love?.bigText || 'Love')}</p>
        <p class="small">${escapeHtml(data.love?.smallText || 'A moment becomes forever')}</p>
      </div>
    </div>
  `);
  app.appendChild(love);

  // Intro（封面）
  const intro = document.createElement('section');
  intro.className = 'chapter';
  intro.dataset.chapter = data.intro?.chapter || 'CHAPTER II';
  intro.dataset.narration = data.intro?.narration || '';
  intro.innerHTML = sectionTemplate(data.intro, `
    <div class="cover">
      <div class="coverImg">
        ${data.intro?.coverImage ? `<img src="${escapeHtml(data.intro.coverImage)}" alt="cover"/>` : ''}
      </div>
      <div>
        <div style="padding:8px 0 0 0;">
          <p style="margin:0;color:rgba(42,28,35,.84);line-height:1.9;font-size:16px;">
            ${escapeHtml(data.intro?.body || data.intro?.narration || '')}
          </p>
          <div class="hint">${escapeHtml(data.intro?.hint || 'Press Continue')}</div>
        </div>
      </div>
    </div>
  `);
  app.appendChild(intro);

  // Timeline（纯按钮翻月 + 中央旁白）
  const tlSec = document.createElement('section');
  tlSec.className = 'chapter';
  tlSec.dataset.chapter = data.timeline?.chapter || 'CHAPTER III';
  tlSec.dataset.narration = data.timeline?.narration || '';
  tlSec.innerHTML = sectionTemplate(data.timeline, `
    <div class="timelineStage" id="timelineStage">
      <div class="monthNarrationCenter" id="monthNarrCenter">
        <div class="pill"><span class="type" id="monthNarrText"></span></div>
      </div>
    </div>

    <div class="monthNav" style="margin-top:16px;display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;">
      <button class="mBtn" id="mPrev" type="button" style="padding:8px 12px;font-size:11px;opacity:.95;">回看（上个月）</button>
      <div class="mLabel" id="mLabel" style="min-width:200px;">MONTH</div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:10px;">
      <button class="btn" id="mNextBig" type="button" style="padding:14px 28px;font-size:12px;">继续（下个月）</button>
    </div>

    <div class="progressRow" style="margin-top:14px;">
      <span id="monthIdx">01</span>
      <div class="bar"><i id="monthBar"></i></div>
      <span id="monthTotal">00</span>
    </div>
  `);
  app.appendChild(tlSec);

  // Attracted
  const att = document.createElement('section');
  att.className = 'chapter';
  att.dataset.chapter = data.attracted?.chapter || 'CHAPTER IV';
  att.dataset.narration = data.attracted?.narration || '';
  const bullets = (data.attracted?.bullets || []).map(x=>`<li>${escapeHtml(x)}</li>`).join('');
  att.innerHTML = sectionTemplate(data.attracted, `<ul class="bullets">${bullets}</ul>`);
  app.appendChild(att);

  // Guess
  const guess = document.createElement('section');
  guess.className = 'chapter';
  guess.dataset.chapter = data.guess?.chapter || 'CHAPTER V';
  guess.dataset.narration = data.guess?.narration || '';
  const opts = (data.guess?.options || []).map((x,i)=>`<div class="opt" data-opt="${i}">${escapeHtml(x)}</div>`).join('');
  guess.innerHTML = sectionTemplate(data.guess, `
    <div class="options" id="opts">${opts}</div>
    <div class="reveal" id="reveal">${escapeHtml(data.guess?.revealText || '')}</div>
  `);
  app.appendChild(guess);

  // Proposal
  const pro = document.createElement('section');
  pro.className = 'chapter';
  pro.dataset.chapter = data.proposal?.chapter || 'CHAPTER VI';
  pro.dataset.narration = data.proposal?.narration || '';
  pro.innerHTML = sectionTemplate(data.proposal, `
    <div style="margin-top:6px;">
      <div style="font-size:22px;line-height:1.45;font-weight:600;margin: 6px 0 6px 0;font-family:'Cormorant Garamond','Noto Serif SC',serif;color:rgba(42,28,35,.92);">
        ${escapeHtml(data.proposal?.question || '你愿意嫁给我吗？')}
      </div>

      <div class="ctaRow" style="position:relative;">
        <button class="btn btnBigYes" id="yesBtn" type="button">
          <span>${escapeHtml(data.proposal?.buttonText || '我愿意')}</span>
          <span class="sub">${escapeHtml(data.proposal?.igniteText || '点燃烟花')}</span>
        </button>

        <button class="btn btnTinyNo" id="noBtn" type="button">
          ${escapeHtml(data.proposal?.noText || '我不愿意')}
        </button>

        <div class="afterText" id="afterText">${escapeHtml(data.proposal?.afterText || '')}</div>
      </div>
    </div>
  `);
  app.appendChild(pro);

  // 初始化交互
  initZeroCountdown(data, zero);
  initLoveCanvas(data, love);
  initTimeline(data, tlSec);
  initGuess(data);
  initProposal(data);
  initChapterFX(data);
  initChapterNavButtons(data);
}

/* =============================
   第零页：倒计时 + “我准备好了”
============================= */
function initZeroCountdown(data, zeroSec){
  const numEl = $('#countNum', zeroSec);
  const btn = $('#readyBtn', zeroSec);
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  let n = clamp((data.zero?.startFrom ?? 5), 1, 9);
  numEl.textContent = String(n);

  const done = ()=>{
    btn.style.display = 'inline-block';
    gsap.fromTo(btn, {autoAlpha:0, y:8}, {autoAlpha:1, y:0, duration:.6, ease:'power2.out'});
    btn.addEventListener('click', ()=>{
      const next = getNextChapter(zeroSec);
      if(next) next.scrollIntoView({behavior:'smooth', block:'start'});
    }, {once:true});
  };

  if(reduce){
    done();
    return;
  }

  const intervalMs = clamp((data.zero?.stepMs ?? 820), 300, 2000);
  const t = setInterval(()=>{
    n -= 1;
    if(n <= 0){
      clearInterval(t);
      gsap.to(numEl, {autoAlpha:0, y:-6, duration:.25, onComplete:done});
      return;
    }
    gsap.fromTo(numEl, {autoAlpha:0, y:10, scale:0.98}, {autoAlpha:1, y:0, scale:1, duration:.35, ease:'power2.out'});
    numEl.textContent = String(n);
  }, intervalMs);
}

/* =============================
   爱情动画页：心形漂浮（Canvas）
============================= */
function initLoveCanvas(data, loveSec){
  const c = $('#loveCanvas', loveSec);
  if(!c) return;
  const ctx = c.getContext('2d');

  let w=0,h=0, hearts=[];
  function resize(){
    const rect = c.parentElement.getBoundingClientRect();
    w = c.width  = rect.width  * devicePixelRatio;
    h = c.height = rect.height * devicePixelRatio;
    c.style.width  = rect.width+'px';
    c.style.height = rect.height+'px';
  }

  function heartPath(x,y,size){
    ctx.beginPath();
    const s = size;
    ctx.moveTo(x, y + s*0.30);
    ctx.bezierCurveTo(x, y, x - s*0.50, y, x - s*0.50, y + s*0.30);
    ctx.bezierCurveTo(x - s*0.50, y + s*0.62, x - s*0.18, y + s*0.85, x, y + s);
    ctx.bezierCurveTo(x + s*0.18, y + s*0.85, x + s*0.50, y + s*0.62, x + s*0.50, y + s*0.30);
    ctx.bezierCurveTo(x + s*0.50, y, x, y, x, y + s*0.30);
    ctx.closePath();
  }

  function spawn(){
    const s = (Math.random()*18 + 10) * devicePixelRatio;
    hearts.push({
      x: Math.random()*w,
      y: h + Math.random()*h*0.2,
      s,
      vy: (Math.random()*0.35 + 0.22) * devicePixelRatio,
      vx: (Math.random()*0.16 - 0.08) * devicePixelRatio,
      a: Math.random()*0.22 + 0.10,
      t: Math.random()*Math.PI*2
    });
    if(hearts.length > 60) hearts.shift();
  }

  function tick(){
    ctx.clearRect(0,0,w,h);

    // 柔光底
    ctx.globalAlpha = 1;
    const g = ctx.createRadialGradient(w*0.3, h*0.3, 0, w*0.3, h*0.3, Math.max(w,h)*0.9);
    g.addColorStop(0, 'rgba(255,255,255,0.55)');
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    for(const p of hearts){
      p.t += 0.01;
      p.x += p.vx + Math.sin(p.t)*0.06*devicePixelRatio;
      p.y -= p.vy;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.fillStyle = 'rgba(255,127,168,1)';
      heartPath(p.x, p.y, p.s);
      ctx.fill();

      ctx.globalAlpha = p.a*0.55;
      ctx.fillStyle = 'rgba(208,164,94,1)';
      heartPath(p.x + p.s*0.08, p.y + p.s*0.06, p.s*0.92);
      ctx.fill();
      ctx.restore();
    }

    hearts = hearts.filter(p => p.y > -p.s*1.2);
    requestAnimationFrame(tick);
  }

  window.addEventListener('resize', resize);
  resize();

  for(let i=0;i<22;i++) spawn();
  setInterval(spawn, 320);

  tick();
}

/* =============================
   Timeline：纯按钮翻月 + 每月旁白居中浮层
============================= */
function initTimeline(data, tlSec){
  const months = data.timeline?.months || [];
  const stage = $('#timelineStage', tlSec);
  const totalEl = $('#monthTotal', tlSec);
  const idxEl = $('#monthIdx', tlSec);
  const barEl = $('#monthBar', tlSec);

  const mPrev = $('#mPrev', tlSec);
  const mNextBig = $('#mNextBig', tlSec);
  const mLabel = $('#mLabel', tlSec);

  const narrBox = $('#monthNarrCenter', tlSec);
  const narrText = $('#monthNarrText', tlSec);

  totalEl.textContent = String(months.length).padStart(2,'0');

  if(months.length === 0){
    stage.innerHTML = `<div style="padding:18px;color:rgba(42,28,35,.70)">在 content.json 里填入 timeline.months 即可。</div>`;
    if(mPrev) mPrev.disabled = true;
    if(mNextBig) mNextBig.disabled = true;
    if(mLabel) mLabel.textContent = 'EMPTY';
    if(narrBox) narrBox.style.display = 'none';
    return;
  }

  const slides = months.map((m,i)=>{
    const el = document.createElement('div');
    el.className = 'monthSlide';
    el.innerHTML = `
      <div class="monthPhoto">
        <img src="${escapeHtml(m.image)}" alt="${escapeHtml(m.title||'')}" />
      </div>
      <div class="monthCard">
        <div>
          <p class="monthTitle">${escapeHtml(m.title || m.month || '')}</p>
          <p class="monthCaption">${escapeHtml(m.caption || '')}</p>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;color:rgba(42,28,35,.62);font-size:12px;letter-spacing:.18em;font-family:'Cinzel',serif;text-transform:uppercase;">
          <span>${escapeHtml(m.month || '')}</span>
          <span>${String(i+1).padStart(2,'0')}</span>
        </div>
      </div>
    `;
    stage.appendChild(el);
    return el;
  });

  let cur = 0;
  let stopMonthTyping = null;

  function syncMonthNarration(){
    const m = months[cur];
    const txt = (m.narration || m.caption || '').toString();
    if(stopMonthTyping) stopMonthTyping();
    if(narrText){
      narrText.textContent = '';
      stopMonthTyping = typeText(narrText, txt, 26);
      gsap.fromTo(narrBox, {autoAlpha:0, scale:0.995}, {autoAlpha:1, scale:1, duration:.35, ease:'power2.out'});
    }
  }

  function syncUI(){
    idxEl.textContent = String(cur+1).padStart(2,'0');
    barEl.style.width = (months.length === 1 ? 100 : (cur/(months.length-1))*100) + '%';
    if(mLabel) mLabel.textContent = (months[cur].month || months[cur].title || `Month ${cur+1}`).toString();
    if(mPrev) mPrev.disabled = (cur === 0);
    if(mNextBig){
      mNextBig.textContent = (cur === months.length-1) ? '继续（下一章）' : '继续（下个月）';
    }
  }

  function showSlide(i, animate=true){
    const next = clamp(i, 0, months.length-1);
    if(next === cur) return;

    const prevEl = slides[cur];
    const nextEl = slides[next];

    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const doAnim = animate && !reduce;

    if(doAnim){
      gsap.to(prevEl, {autoAlpha:0, scale:1.02, duration:0.28, ease:'power2.out'});
      gsap.fromTo(nextEl, {autoAlpha:0, scale:1.02}, {autoAlpha:1, scale:1.00, duration:0.36, ease:'power2.out'});
    }else{
      gsap.set(prevEl, {autoAlpha:0, scale:1.02});
      gsap.set(nextEl, {autoAlpha:1, scale:1.00});
    }

    cur = next;
    syncUI();
    syncMonthNarration();
  }

  slides.forEach((s,i)=> gsap.set(s, {autoAlpha: i===0?1:0, scale: i===0?1:1.02}));
  syncUI();
  syncMonthNarration();

  if(mPrev) mPrev.addEventListener('click', ()=> showSlide(cur-1, true));
  if(mNextBig) mNextBig.addEventListener('click', ()=>{
    if(cur < months.length-1){
      showSlide(cur+1, true);
    }else{
      const nextSec = getNextChapter(tlSec);
      if(nextSec) nextSec.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });

  const nav = $('[data-chapnav]', tlSec);
  if(nav) nav.style.display = 'none';
}

/* =============================
   Guess interaction
============================= */
function initGuess(){
  const box = $('#opts');
  if(!box) return;
  const reveal = $('#reveal');
  box.addEventListener('click', (e)=>{
    const opt = e.target.closest('.opt');
    if(!opt) return;
    $$('.opt', box).forEach(x=>x.classList.remove('selected'));
    opt.classList.add('selected');
    if(reveal){
      reveal.style.display = 'block';
      gsap.fromTo(reveal, {autoAlpha:0, y:10}, {autoAlpha:1, y:0, duration:.6, ease:'power2.out'});
    }
  });
}

/* =============================
   Proposal + Finale fireworks + 终章两页
============================= */
let __finaleCleanup = null;

function initProposal(data){
  const yes = $('#yesBtn');
  const no  = $('#noBtn');
  const after = $('#afterText');
  if(!yes) return;

  // 最后一章隐藏“继续”，避免和点燃烟花冲突
  const proSec = yes.closest('section.chapter');
  const nav = $('[data-chapnav]', proSec);
  if(nav){
    const nextBtn = $('[data-next]', nav);
    if(nextBtn) nextBtn.style.display = 'none';
  }

  yes.addEventListener('click', ()=>{
    if(after){
      after.style.display = 'block';
      after.textContent = data.proposal?.afterText || '那就把这一天，记成一辈子。';
      gsap.fromTo(after, {autoAlpha:0, y:8}, {autoAlpha:1, y:0, duration:.6, ease:'power2.out'});
    }
    startFinale(data);
  });

  // “我不愿意”——抖动/躲避更大（你要求：加大）
  if(no){
    let moved = 0;
    const maxMoves = 10;

    const bigMoveAway = ()=>{
      if(moved >= maxMoves) return;
      moved++;
      const dx = (Math.random()*260 - 130); // 更大
      const dy = (Math.random()*120  - 60); // 更大
      const rot = (Math.random()*18 - 9);   // 加一点旋转
      gsap.to(no, {x: dx, y: dy, rotation: rot, duration:0.18, ease:'power2.out'});
    };

    const bigShake = ()=>{
      const tl = gsap.timeline();
      tl.to(no, {x:'+=18', y:'-=6', rotation:'+=6', duration:0.06})
        .to(no, {x:'-=32', y:'+=10', rotation:'-=10', duration:0.06})
        .to(no, {x:'+=28', y:'-=8', rotation:'+=8', duration:0.06})
        .to(no, {x:'-=20', y:'+=6', rotation:'-=6', duration:0.06})
        .to(no, {x:'+=10', y:'-=3', rotation:'+=2', duration:0.06});
    };

    no.addEventListener('mouseenter', ()=>{
      bigMoveAway();
      bigShake();
    });

    no.addEventListener('click', (e)=>{
      e.preventDefault();
      bigMoveAway();
      bigShake();
      if(after){
        after.style.display = 'block';
        after.textContent = data.proposal?.noAfterText || '再想想嘛。';
        gsap.fromTo(after, {autoAlpha:0, y:8}, {autoAlpha:1, y:0, duration:.5, ease:'power2.out'});
      }
    });
  }
}

function startFinale(data){
  const overlay = $('#finaleOverlay');
  const canvas = $('#finaleCanvas');
  const title = $('#finaleTitle');
  const sub = $('#finaleSub');
  const smoke = $('#smokeLayer');

  const fin = data.finale || {};
  title.textContent = fin.title || 'For You';
  sub.textContent = fin.subtitle || 'Press Esc to exit';

  overlay.style.display = 'block';
  overlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';

  const smokeOn = !!fin.enableSmokeLayer;
  if(smoke && smokeOn){
    smoke.style.opacity = '.65';
  }else if(smoke){
    smoke.style.opacity = '0';
  }

  const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });

  const D = clamp((fin.durationSeconds || 10), 3, 30) * 1000;
  const t0 = Date.now();

  const burst = ()=>{
    myConfetti({ particleCount: 70, spread: 70, origin: {x:0.22, y:0.85}, scalar: 1.05 });
    myConfetti({ particleCount: 80, spread: 75, origin: {x:0.78, y:0.85}, scalar: 1.05 });
    myConfetti({ particleCount: 90, spread: 95, origin: {x:0.50, y:0.55}, scalar: 1.20 });
  };

  burst();

  const iv = setInterval(()=>{
    burst();
    if(Date.now()-t0 > D){
      clearInterval(iv);
      myConfetti({ particleCount: 210, spread: 120, origin: {x:0.5, y:0.60}, scalar: 1.25 });

      // 烟花结束 -> 终章两页
      setTimeout(()=>{
        cleanup({keepLocked:true});   // 关掉烟花层，但保持滚动锁定（由 endCard 控制）
        showEndCard(data);
      }, 900);
    }
  }, 520);

  const onKey = (e)=>{
    if(e.key === 'Escape'){
      cleanup({keepLocked:false});
    }
  };

  function cleanup({keepLocked=false}={}){
    clearInterval(iv);
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    if(!keepLocked) document.body.style.overflow = '';
    window.removeEventListener('keydown', onKey);
    __finaleCleanup = null;
  }

  __finaleCleanup = cleanup;
  window.addEventListener('keydown', onKey);
}

/* ===== 终章两页逻辑 ===== */
function showEndCard(data){
  const card = $('#endCard');
  const t = $('#endCardTitle');
  const b = $('#endCardBody');
  const ok = $('#endCardOkBtn');
  const close = $('#endCardCloseBtn');

  // 页 1
  t.textContent = data.endCard?.page1Title || '你以为这就完了';
  b.innerHTML = (data.endCard?.page1Body || '确实这就结束了，但我们的故事将继续。<br/>请点击确定。');

  close.style.display = 'none';

  card.style.display = 'block';
  card.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';

  // 防重复绑定：用 clone 替换按钮
  const okClone = ok.cloneNode(true);
  ok.parentNode.replaceChild(okClone, ok);

  const closeClone = close.cloneNode(true);
  close.parentNode.replaceChild(closeClone, close);

  okClone.addEventListener('click', ()=>{
    // 页 2
    t.textContent = data.endCard?.page2Title || '请点击确定';
    b.innerHTML = (data.endCard?.page2Body || '确定后，公主请下车，请移步至后备箱。');
    closeClone.style.display = 'inline-flex';
    gsap.fromTo($('.endCardBox', card), {autoAlpha:0, scale:0.99, y:8}, {autoAlpha:1, scale:1, y:0, duration:.35, ease:'power2.out'});
  });

  closeClone.addEventListener('click', ()=>{
    hideEndCard();
  });

  // ESC 关闭 endCard
  const onKey = (e)=>{
    if(e.key === 'Escape'){
      hideEndCard();
      window.removeEventListener('keydown', onKey);
    }
  };
  window.addEventListener('keydown', onKey);

  gsap.fromTo($('.endCardBox', card), {autoAlpha:0, scale:0.985, y:10}, {autoAlpha:1, scale:1, y:0, duration:.45, ease:'power2.out'});
}

function hideEndCard(){
  const card = $('#endCard');
  card.setAttribute('aria-hidden','true');
  card.style.display = 'none';
  document.body.style.overflow = '';

  // 兜底：如果烟花层还没清理（一般不会发生）
  if(typeof __finaleCleanup === 'function'){
    __finaleCleanup({keepLocked:false});
  }
}

/* =============================
   章节进入：顶部 Chapter + 旁白
============================= */
function initChapterFX(){
  const tag = $('#chapterTag');
  const sections = $$('#app section.chapter');
  let stopTyping = null;

  const io = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      if(en.isIntersecting){
        const sec = en.target;
        tag.textContent = sec.dataset.chapter || 'CHAPTER';

        const t = $('[data-narration]', sec);
        const txt = sec.dataset.narration || '';
        if(stopTyping) stopTyping();
        stopTyping = typeText(t, txt, 26);

        const card = $('.glass', sec);
        if(card && !card.dataset.played && !window.matchMedia('(prefers-reduced-motion: reduce)').matches){
          card.dataset.played = '1';
          gsap.fromTo(card, {autoAlpha:0, y:16, scale:0.995}, {autoAlpha:1, y:0, scale:1, duration:0.9, ease:'power3.out'});
        }
      }
    });
  }, { threshold: 0.55 });

  sections.forEach(s=>io.observe(s));
}

/* =============================
   章节按钮：回看 / 继续（按钮进入下一章节）
============================= */
function getPrevChapter(sec){
  const chapters = $$('#app section.chapter');
  const idx = chapters.indexOf(sec);
  return chapters[idx-1] || null;
}
function getNextChapter(sec){
  const chapters = $$('#app section.chapter');
  const idx = chapters.indexOf(sec);
  return chapters[idx+1] || null;
}

function initChapterNavButtons(){
  const chapters = $$('#app section.chapter');

  chapters.forEach((sec, idx)=>{
    const nav = $('[data-chapnav]', sec);
    if(!nav) return;

    const prevBtn = $('[data-prev]', nav);
    const nextBtn = $('[data-next]', nav);

    const isZero = (idx === 0);
    if(isZero){
      nav.style.display = 'none';
      return;
    }

    if(prevBtn){
      prevBtn.textContent = '回看';
      prevBtn.disabled = (idx <= 1);
      prevBtn.addEventListener('click', ()=>{
        const prev = getPrevChapter(sec);
        if(prev) prev.scrollIntoView({behavior:'smooth', block:'start'});
      });
    }

    if(nextBtn){
      nextBtn.textContent = '继续';
      nextBtn.addEventListener('click', ()=>{
        const next = getNextChapter(sec);
        if(next) next.scrollIntoView({behavior:'smooth', block:'start'});
      });
    }
  });
}

/* =============================
   音乐按钮（可选）
============================= */
function initMusic(data){
  const m = data.music || {};
  const btn = $('#musicBtn');
  if(!m.enabled || !m.file) return;
  btn.style.display = 'inline-flex';
  btn.textContent = m.buttonLabel || 'BGM';

  const audio = new Audio(m.file);
  audio.loop = true;
  audio.volume = 0.7;
  let on = false;

  btn.addEventListener('click', async ()=>{
    try{
      if(!on){
        await audio.play();
        on = true;
        btn.style.borderColor = 'rgba(208,164,94,.55)';
      }else{
        audio.pause();
        on = false;
        btn.style.borderColor = 'rgba(208,164,94,.28)';
      }
    }catch(err){
      console.warn(err);
    }
  });
}

/* =============================
   启动
============================= */
(async function(){
  initSparkles();
  initPetals();

  if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    gsap.to('#curtain', {autoAlpha:0, duration:1.0, delay:0.25, ease:'power2.out', onComplete:()=>$('#curtain')?.remove()});
  }else{
    $('#curtain')?.remove();
  }

  try{
    const data = await loadContent();
    document.title = data?.meta?.siteTitle || 'Proposal';
    setRootTheme(data?.theme);
    buildApp(data);
    initMusic(data);
  }catch(err){
    console.error(err);
    $('#app').innerHTML = `
      <section class="chapter">
        <div class="wrap">
          <div class="glass">
            <div class="content">
              <div class="kicker">ERROR</div>
              <h1>无法加载 content.json</h1>
              <p class="subtitle">请用本地服务器方式打开（不要直接双击 index.html）。</p>
              <pre style="white-space:pre-wrap;color:rgba(42,28,35,.85);line-height:1.7;background:rgba(255,255,255,.55);padding:14px;border-radius:14px;border:1px solid rgba(208,164,94,.18);">python3 -m http.server 8080
然后浏览器打开：http://localhost:8080/</pre>
            </div>
          </div>
        </div>
      </section>`;
  }
})();
</script>
</body>
</html>
